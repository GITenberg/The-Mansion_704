sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: eom3ttbv/WEon8Anx+neYNWArXOEYSZdqzchCqrXL+YKzAXWTuBQAmtcPDdH3ic9Q3X85+5IPPmamnxqZoDXWtWkeF7trywx4IxIT71ebi0kp0XzKjwzO9kD+RUBqr7Oc1u5zIUk8WQ8FZsF000L82F6LQAXbF4iolV04dk+xyICtjQwsRJbzEyOlJkxjHusfgj20AAKu+0wMgdOHnrfSDEl8bBOn1rp8Ac24MMcPALyd+2aNzoZrLc1nk4CoCKKAzDuE7D6NpSF+12nC/bATVNGp0CfDqL+Xp6/KHDDJgVL4Xwa+GOKwRewdiFVoO9rkwS575cBK3Lx6dQOngiXMeoFw8TadRkZxJcIp2McUD2B951b0Uyl08I+K15wwWM4pe3AlqsU8Crcx8oWuieVUyKZM9zEJQw59rOinyE6F39YxtTpEJbe5kMai2gVnJWkZO00tAAYUxuerEydwekVyWVdJJEW3OYKHeSb2RHpF/usR4JOiA3+udAA7pjrlSgFG2g/6PvI0VSgVjPiO8oeytzEQMN7GXu/7leMTJ/w87zV3+Uf4QKtM+iRBb8LUQ8uYXFVeIOGg1cREiuixim+cjauu6CVhAhCeI6pFKowePw4r3/YhW7GKtl4nErwEAefGoTmjd4qpvw8eTlKphhdH+NXIdTHzbfYbVLZIzh9Umo=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/The-Mansion_704
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy